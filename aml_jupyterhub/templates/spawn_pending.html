{% extends "templates/spawn_pending.html" %} {% block message %} {{ super() }}


<dialog id="user-attention-dialog" style="font-size: 140%;">
    <p id="dialog-msg">test message</p>
</dialog>

<script>
    // https://github.com/bryanwoods/autolink-js
    // Generated by CoffeeScript 1.10.0
    (function() {
        var autoLink,
            slice = [].slice;

        autoLink = function() {
            var callback, k, linkAttributes, option, options, pattern, v;
            options = 1 <= arguments.length ? slice.call(arguments, 0) : [];
            pattern = /(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi;
            if (!(options.length > 0)) {
                return this.replace(pattern, "$1<a href='$2'>$2</a>");
            }
            option = options[0];
            callback = option["callback"];
            linkAttributes = ((function() {
                var results;
                results = [];
                for (k in option) {
                    v = option[k];
                    if (k !== 'callback') {
                        results.push(" " + k + "='" + v + "'");
                    }
                }
                return results;
            })()).join('');
            return this.replace(pattern, function(match, space, url) {
                var link;
                link = (typeof callback === "function" ? callback(url) : void 0) || ("<a href='" + url + "'" + linkAttributes + ">" + url + "</a>");
                return "" + space + link;
            });
        };

        String.prototype['autoLink'] = autoLink;

    }).call(this);
</script>


<script type="text/javascript">
    function copy_token(target) {
        console.log(target);
        var eid = target.getAttribute("data-ele-to-copy");
        var el = document.getElementById(eid);
        var range, selection;

        if (window.getSelection && document.createRange) {
            selection = window.getSelection();
            range = document.createRange();
            range.selectNodeContents(el);
            selection.removeAllRanges();
            selection.addRange(range);
        } else if (document.selection && document.body.createTextRange) {
            range = document.body.createTextRange();
            range.moveToElementText(el);
            range.select();
        }
        document.execCommand('copy');
        console.log('copied');
    }

    (function() {
        var IMPORTANT_MSG_PREFIX = "**"
        var IMPORTANT_MSG_SUFFIX = "**"
        var LOGIN_CODE_REGEX = new RegExp('\\b[A-Z0-9]{9}\\b', 'g')

        var msg_change_timeout = null;

        function emphMsgIfImportant(msg) {
            if (msg.trim().startsWith(IMPORTANT_MSG_PREFIX)) {
                console.log('Important message:', msg)
                msg = msg.substr(IMPORTANT_MSG_PREFIX.length, msg.length - IMPORTANT_MSG_SUFFIX.length - IMPORTANT_MSG_PREFIX.length)
                showEmpDialog(importantMessageToHTML(msg))
            } else {
                console.log('Not important message:', msg)
                hideEmpDialog("")
            }
        }



        function importantMessageToHTML(msg) {

            // Find any special login tokens
            tokens = msg.match(LOGIN_CODE_REGEX)
            tokens = [...new Set(tokens)]
            for (let i = 0; i < tokens.length; i++) {
                token = tokens[i]
                eid = Math.random().toString(36).substring(2, 15)
                msg = msg.replace(new RegExp(token, 'g'), `<em style="font-weight: bold;" id="${eid}">${token}</em><sup><a onclick="copy_token(this)" title="Copy code" href="#" data-ele-to-copy="${eid}">ðŸ“‹</a></sup>`)
            }
            // create links from urls
            msg = msg.autoLink({
                target: "_blank",
                rel: "nofollow"
            });

            return msg
        }

        function getMsg() {
            element = document.getElementById('progress-message')
            if (element) {
                return element.innerText
            } else {
                return ""
            }
        }

        var lastMsg = ""

        function triggerOnMessageChange(func) {
            newMsg = getMsg()
            if (newMsg !== lastMsg) {
                console.log('Message change:', newMsg, lastMsg)
                func(newMsg)
                lastMsg = newMsg
            }
        }

        function hideEmpDialog(msg) {
            var dialog = document.getElementById('user-attention-dialog');
            if (typeof dialog.close === "function") {
                msgEle = document.getElementById('dialog-msg')
                msgEle.innerText = msg;
                dialog.close();
            }
        }

        function showEmpDialog(msg) {
            var dialog = document.getElementById('user-attention-dialog');
            if (typeof dialog.showModal === "function") {
                msgEle = document.getElementById('dialog-msg')
                msgEle.innerHTML = msg
                dialog.showModal();
            } else {
                alert(msg);
            }
        }

        msg_change_timeout = setInterval(() => {
            triggerOnMessageChange(emphMsgIfImportant)
        }, 500)

    })()
</script>
{% endblock %}